import pygame
import sys
import math
import random

# Initialize Pygame
pygame.init()

# Constants
WIDTH, HEIGHT = 800, 600
FPS = 60

# Colors
WHITE = (255, 255, 255)
BLACK = (0, 0, 0)
GREEN = (0, 255, 0)
RED = (255, 0, 0)

# Create the screen
screen = pygame.display.set_mode((WIDTH, HEIGHT))
pygame.display.set_caption("2D RPG")

# Clock for controlling the frame rate
clock = pygame.time.Clock()

# Define Character class
class Character(pygame.sprite.Sprite):
    def __init__(self, name, health, attack, defense, color, initial_position):
        super().__init__()
        self.image = pygame.Surface((50, 50), pygame.SRCALPHA)
        pygame.draw.circle(self.image, color, (25, 25), 25)
        self.rect = self.image.get_rect()
        self.name = name
        self.health = health
        self.attack = attack
        self.defense = defense
        self.angle = 0
        self.rect.topleft = initial_position

        # Add a pupil
        self.pupil_radius = 5
        self.pupil_color = BLACK
        self.pupil_offset = (0, 0)

    def take_damage(self, damage):
        self.health -= damage
        if self.health < 0:
            self.health = 0

    def die(self):
        self.health = 100  # Reset health
        self.speed *= 2  # Double speed

    def follow_target(self, target):
        angle = math.degrees(math.atan2(target.rect.centery - self.rect.centery, target.rect.centerx - self.rect.centerx))
        self.rect.x += self.speed * math.cos(math.radians(angle))
        self.rect.y += self.speed * math.sin(math.radians(angle))

    def update_pupil(self, cursor_position):
        dx = cursor_position[0] - self.rect.centerx
        dy = cursor_position[1] - self.rect.centery
        angle = math.atan2(dy, dx)
        distance = min(self.rect.width / 2 - self.pupil_radius, self.rect.height / 2 - self.pupil_radius)
        self.pupil_offset = (int(distance * math.cos(angle)), int(distance * math.sin(angle)))

    def update(self, *args, **kwargs):
        cursor_position = kwargs.get('cursor_position', (0, 0))
        self.update_pupil(cursor_position)

# Create player sprite
player_initial_position = (WIDTH - 100, HEIGHT - 100)
player = Character("Player", 100, 20, 10, GREEN, player_initial_position)

# Create enemy sprite
enemy_initial_position = (100, 100)
enemy = Character("Enemy", 100, 15, 5, RED, enemy_initial_position)
enemy.speed = 2  # Set enemy speed

# Create player gun
class Gun(pygame.sprite.Sprite):
    def __init__(self, owner):
        super().__init__()
        self.image = pygame.Surface((20, 10), pygame.SRCALPHA)
        pygame.draw.rect(self.image, BLACK, (0, 0, 20, 10))
        self.rect = self.image.get_rect(center=owner.rect.center)
        self.owner = owner
        self.bullets = pygame.sprite.Group()

    def shoot(self):
        mouse_x, mouse_y = pygame.mouse.get_pos()
        angle = math.degrees(math.atan2(mouse_y - self.rect.centery, mouse_x - self.rect.centerx))

        gun_barrel = self.rect.midright
        rotated_image = pygame.transform.rotate(self.image, -angle)
        rotated_rect = rotated_image.get_rect(center=self.owner.rect.center)

        bullet = Bullet(rotated_rect.midright, angle)
        self.bullets.add(bullet)

    def update(self):
        mouse_x, mouse_y = pygame.mouse.get_pos()
        self.owner.angle = math.degrees(math.atan2(mouse_y - self.rect.centery, mouse_x - self.rect.centerx))
        self.image = pygame.Surface((20, 10), pygame.SRCALPHA)
        pygame.draw.rect(self.image, BLACK, (0, 0, 20, 10))
        self.image = pygame.transform.rotate(self.image, -self.owner.angle)
        self.rect = self.image.get_rect(center=self.owner.rect.center)
        self.bullets.update()

class Bullet(pygame.sprite.Sprite):
    def __init__(self, position, angle):
        super().__init__()
        self.image = pygame.Surface((5, 5), pygame.SRCALPHA)
        pygame.draw.circle(self.image, (0, 0, 255), (2, 2), 2)
        self.rect = self.image.get_rect(topleft=position)
        self.angle = angle
        self.speed = 5

    def update(self):
        self.rect.x += self.speed * math.cos(math.radians(self.angle))
        self.rect.y += self.speed * math.sin(math.radians(self.angle))

class Trap(pygame.sprite.Sprite):
    def __init__(self, position):
        super().__init__()
        self.image = pygame.Surface((20, 20), pygame.SRCALPHA)
        pygame.draw.rect(self.image, RED, (0, 0, 20, 20))
        self.rect = self.image.get_rect(topleft=position)
        self.activated = False  # Add an attribute to track activation state

    def activate(self, character):
        if not self.activated:
            knockback_direction = pygame.Vector2(character.rect.centerx - self.rect.centerx, character.rect.centery - self.rect.centery)
            if knockback_direction.length() > 0:
                knockback_direction.normalize_ip()
                character.rect.x += 20 * knockback_direction.x
                character.rect.y += 20 * knockback_direction.y

            self.activated = True  # Mark the trap as activated

# Added a method to reset the traps
def reset_traps():
  traps.empty()
  for _ in range(5):
      trap = Trap((random.randint(0, WIDTH - 20), random.randint(0, HEIGHT - 20)))
      traps.add(trap)

# Initialize player, enemy, and traps
all_sprites = pygame.sprite.Group(player, enemy)
player_gun = Gun(player)
all_sprites.add(player_gun)
traps = pygame.sprite.Group()
reset_traps()  # Initialize traps

# Game loop
round_number = 1
running = True
while running:
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False
        elif event.type == pygame.KEYDOWN:
            if event.key == pygame.K_SPACE:
                player_gun.shoot()

    keys = pygame.key.get_pressed()
    if keys[pygame.K_w] and player.rect.y > 0:
        player.rect.y -= 5
    if keys[pygame.K_s] and player.rect.y < HEIGHT - player.rect.height:
        player.rect.y += 5
    if keys[pygame.K_a] and player.rect.x > 0:
        player.rect.x -= 5
    if keys[pygame.K_d] and player.rect.x < WIDTH - player.rect.width:
        player.rect.x += 5

    # Update player and check for collisions with the enemy
    player.update(cursor_position=pygame.mouse.get_pos())
    player_gun.update()

    # Update enemy and check for collisions with the player
    enemy.follow_target(player)
    enemy.update()
    if pygame.sprite.collide_rect(player, enemy):
        player.take_damage(10)
        if player.health <= 0:
            running = False

    # Check for collisions between bullets and enemies
    bullet_hits = pygame.sprite.groupcollide(player_gun.bullets, all_sprites, True, False)
    for bullet, hit_enemies in bullet_hits.items():
        for hit_enemy in hit_enemies:
            if isinstance(hit_enemy, Character):
                hit_enemy.take_damage(10)

    # Check for collisions between traps and characters
    for trap in traps:
        hit_traps = pygame.sprite.spritecollide(trap, all_sprites, False)
        for hit_character in hit_traps:
            if isinstance(hit_character, Character):
                trap.activate(hit_character)

    all_sprites.update()
    traps.update()

    screen.fill(WHITE)
    all_sprites.draw(screen)
    traps.draw(screen)

    # Draw pupils
    pygame.draw.circle(player.image, player.pupil_color, (player.rect.centerx + player.pupil_offset[0], player.rect.centery + player.pupil_offset[1]), player.pupil_radius)
    pygame.draw.circle(enemy.image, enemy.pupil_color, (enemy.rect.centerx + enemy.pupil_offset[0], enemy.rect.centery + enemy.pupil_offset[1]), enemy.pupil_radius)

    for bullet in player_gun.bullets:
        screen.blit(bullet.image, bullet.rect)

    # Check if the enemy has died
    if enemy.health <= 0:
        round_number += 1
        enemy.die()
        reset_traps()

        # Respawn the enemy
        enemy.rect.topleft = (100, 100)

        print(f"Round {round_number}")

    # Flip the display
    pygame.display.flip()

    # Cap the frame rate
    clock.tick(FPS)

# Quit the game
pygame.quit()
sys.exit()
